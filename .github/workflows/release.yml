name: Create Release

on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      html_url: ${{ steps.create_release.outputs.html_url }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Create Release
      id: create_release
      uses: actions/create-release@v4
      with:
        tag_name: ${{ github.ref_name }}
        release_name: Context42 ${{ github.ref_name }}
        body: |
          ## Context42 MCP RAG Server ${{ github.ref_name }}
          
          ### ğŸš€ Features
          - FastMCP-based MCP server for local text search
          - Multi-format document support (.md, .txt, .rst, .json, .yaml, .toml, .csv, .log)
          - Intelligent compression chunking (1x-128x)
          - Keyword relevance search with previews
          - uvx-installable globally
          - Full test coverage (11/11 tests passing)
          
          ### ğŸ› ï¸ Installation
          ```bash
          uvx install context42
          uvx context42
          ```
          
          ### ğŸ”§ Integration
          ```json
          {
            "mcpServers": {
              "context42": {
                "command": "uvx",
                "args": ["context42"]
              }
            }
          }
          ```
          
          ### ğŸ“Š Changes
          - Migrated from manual MCP to FastMCP decorators
          - Added comprehensive test suite
          - Fixed critical division-by-zero bug
          - Added input validation
          - Extended file format support
          - Improved error handling
          
          ### ğŸ§ª Testing
          - 11/11 tests passing
          - Coverage: DocumentProcessor, Chunker, SearchEngine, Integration
          
          ---  
          ğŸ“„ License: MIT
          ğŸ“§ Author: Aleksandr Beshkenadze
        draft: false
        prerelease: false
    
    - name: Set up UV
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
    
    - name: Build package
      run: uv build
    
    - name: Upload Release Asset
      uses: actions/upload-release-asset@v4
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist/context42-0.1.0-py3-none-any.whl
        asset_name: context42-0.1.0-py3-none-any.whl
        asset_content_type: application/octet-stream
    
    - name: Upload Source Asset
      uses: actions/upload-release-asset@v4
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist/context42-0.1.0.tar.gz
        asset_name: context42-0.1.0.tar.gz
        asset_content_type: application/gzip